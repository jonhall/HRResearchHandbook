%%https://tex.stackexchange.com/questions/94845/problems-with-toprule-and-midrule-in-a-table
\RequirePackage{booktabs}%%For fancy lines in tables
\RequirePackage{multicol}%%For multiple columns

%%For additional caption options
%%Allows captions in longtables
\RequirePackage{caption}
\RequirePackage{float}

%%%For tables – intention is to migrate to tabularray
\RequirePackage{longtable,tabulary,tabularray}
\UseTblrLibrary{varwidth}%%For itemize in entries
\UseTblrLibrary{counter}%%For counters in tables

%%tabulary gives L column
%%David Carlisle's mix of tabulary and longtable from https://tex.stackexchange.com/questions/78075/multi-page-with-tabulary
\makeatletter
\def\ltabulary{%
	\def\endfirsthead{\\}%
	\def\endhead{\\}%
	\def\endfoot{\\}%
	\def\endlastfoot{\\}%
	\def\tabulary{%
		\def\TY@final{%
			\def\endfirsthead{\LT@end@hd@ft\LT@firsthead}%
			\def\endhead{\LT@end@hd@ft\LT@head}%
			\def\endfoot{\LT@end@hd@ft\LT@foot}%
			\def\endlastfoot{\LT@end@hd@ft\LT@lastfoot}%
%JGH Not yet working	\let\caption\LT@caption%%JGH 2023-10-13: Added to allow ltabulary captions
%			\let\LT@mcol\multicolumn%%JGH 2023-10-13
			\longtable}%
		\let\endTY@final\endlongtable
		\TY@tabular}%
%	\dimen@\columnwidth
%	\advance\dimen@-\LTleft
%	\advance\dimen@-\LTright
	\tabulary}%\dimen@}
\makeatother

\def\endltabulary{\endtabulary}

%%so that tables extend into margin
\newdimen\tablewidth
\setlength{\tablewidth}{1.4\textwidth}
%%Report list formats 
\usepackage{enumitem}
%%To define reportenumerate list for report tables
%\usepackage{enumitem}
\newlist{reportenum}{enumerate}{2}
\setlist[reportenum]{nosep}
\setlist[reportenum,1]{label={\arabic*}}
%\setlist[reportenum,2]{resume}
\newlist{reportitem}{itemize}{1}
\setlist[reportitem]{nosep,label=\textbullet}

\NewTblrEnviron{reportblr}
\SetTblrOuter[reportblr]{long,expand=\expanded}
\SetTblrInner[reportblr]{measure=vbox, stretch=-1,%%Allows lists in body, with no padding
  hlines = {gray8,wd=5pt}, %column{2} = {co=1}, 
  colsep = 5pt,
%  row{odd} = {gray8},% row{even} = {gray8},
  column{1} = {fg=black, bg=azure8, font=\sffamily},%{\bfseries\sffamily},
  row{1} = {fg=black, bg=azure8, font=\bfseries\sffamily},
  rowhead = 1,
%  colspec={X[8,l]X[1,c,wd=22pt]X[18]}
  colspec={X[8,l]X[18,preto={\begin{itemize}[nosep,left=0pt]\item },appto={\end{itemize}}]X[1]}
}

\usepackage{ifthen}

\newcommand{\ritem}[2]{%
	\ifthenelse{\equal{#1}{!}}
		%%new section
		{\item[\color{red}\textbullet]\color{black}}
		{\ifthenelse{\equal{#1}{*}}
			%%updated section
			{\item[\color{black}\textbullet]\color{black}}
			%%not yet included						
			{\item[\color{gray4}\textbullet]\color{gray4}}
		}
	#2}

\newcommand{\titem}[2]{%
	\ifthenelse{\equal{#1}{*}}%
		{\color{black}}%
		{\color{gray4}}%
	#2}

\newcommand\ReportTitle[1]{\reportline3 \titem{#1}{Title}}

\newcommand\ReportAbstract[5]
	{\reportline3 \titem{#1}{Abstract}
	\begin{reportenum}
		\ritem{#2} {Background}
		\ritem{#3} {Research Outline}
		\ritem{#4} {Research Design}
		\ritem{#5} {Knowledge contribution}
	\end{reportenum}
}
	
\newcommand\ReportIntroduction[5]%
	{\reportline3 \titem{#1}{Chapter 1: Introduction}
	\begin{reportenum}
		\ritem {#2} {Background to the research}
		\ritem {#3} {Justification for the research}
		\ritem {#4} {Definitions}
		\ritem {#5} {Outline of the dissertation}
	\end{reportenum}
}

\newcommand\ReportLitRev[3]%
	{\reportline3 \titem{#1}{Chapter 2: Literature review}
	 \begin{reportenum}
		\ritem {#2}{Review of existing relevant knowledge}
		\ritem {#3}{Critical summary, including knowledge gap to be addressed by the research}
	\end{reportenum}
}

\newcommand\ReportResearchDef[4]%
	{\reportline3 \titem{#1}{Chapter 3: Research Definition}
		 \begin{reportenum}
			\ritem{#2}  {Problem statement}
			\ritem{#3}  {Aim, objectives, tasks and deliverables} 
			\ritem{#4}  {Knowledge contribution}
		\end{reportenum}
	}

\newcommand\ReportResearchDes[5]%
	{\reportline3   \titem{#1}{Chapter 4: Research design}
		 \begin{reportenum}
			\ritem{#2}  {Data Generation} 
			\ritem{#3}  {Research strategy and methods} 
			\ritem{#4}  {Research procedures} 
			\ritem{#5}  {Ethical, legal and EDI considerations} 
		\end{reportenum}
	}

\newcommand\ReportAnalysisInterp[4]%
	{\reportline3  \titem{#1}{Chapter 5: Analysis and interpretation}
		 \begin{reportenum}
			\ritem{#2}  {Summary and analysis of data} 
			\ritem{#3}  {Summary of key findings} 
			\ritem{#4} {Interpretation in relation to aim and objectives} 
		\end{reportenum}
	}

\newcommand\ReportEvalConc[7]%
	{\reportline3   \titem{#1}{Chapter 6: Evaluation and conclusion}
	 \begin{reportenum}
		\ritem{#2}  {Evaluation against aim and objectives} 
		\ritem{#3}  {Evaluation against related work in the literature} 
		\ritem{#4}  {Implications for practice} 
		\ritem{#5}  {Validity of the research} 
		\ritem{#6}  {Further work} 
		\ritem{#7}  {Personal reflection on your experience} 
	\end{reportenum}
}

\newcommand\ReportRefs[1]{\reportline3 \titem{#1}{References}}

\newcommand\ReportAppendices[1]{\reportline3 \titem{#1}{Appendices}}

\newcommand\ReportProgressTracking[9]%
	{\reportline3 \titem{#1}{Progress tracking}
	\begin{reportenum}
		\ritem{#2}{Qualification fit}
		\ritem{#3}{Personal and professional fit}
		\ritem{#4}{Technical skills and resources needed}
		\ritem{#5}{Statement of feasibility}
		\ritem{#6}{Further reading to be completed}
		\ritem{#7}{Work schedule}
		\ritem{#8}{Risk assessment}
		\ritem{#9}{Risk Assessment Table(s)}
	\end{reportenum}
}

\newcommand\ReportReflection[3]%
	{\reportline3 \titem{#1}{Reflection}
	\begin{reportenum}
		\ritem{#2}{Personal reflection on research process}
		\ritem{#3}{Key priorities in follow-up stage}
	\end{reportenum}
}

%%for section, etc, xreferencing without needing to identify part
\RequirePackage{cleveref}

\newcommand{\basedOn}[1]{that is based on the work you completed in \Cref{#1}}
%%repeated report table messages
\newcommand\tablenocontent{No content at this stage}
\newcommand\tablecites{You should include those references that you cite in new and/or update chapters}
%\newcommand\tableconsiderprogress{Ensure all cited references are listed in this section}
\newcommand\tablefinalise[1]{After completing your work for this state, finalise your #1}
\newcommand\tableminor[1]{Reread and make any minor modifications to your #1}
\newcommand\tablecheck[1]{You should check your #1 for correctness and completeness}

\RequirePackage{tabularray}

%%For tables – intention is to migrate to tabularray
%%Updated macros from comments on tabularray https://github.com/lvjr/tabularray/issues/448
\usepackage{longtable,tabulary,tabularray}%Remove longtable and tabulary when complete
\UseTblrLibrary{varwidth}%%For itemize in entries
\UseTblrLibrary{counter}%%For counters in tables

%\usepackage{xpatch}

%%Table definitions

%%Research Activities, one per stage
%%use 
%%\begin{ResActtblr}[caption={...}]{}
%%\tableheader	
%%...
%%\end{ResActtblr}
\NewTblrEnviron{ResActtblr}
\SetTblrOuter[ResActtblr]{long,expand=\reportline,expand=\tableheader}
\SetTblrInner[ResActtblr]{measure=vbox, stretch=-1,%%Allows lists in body, with no padding
  width=\textwidth,
  hlines = {gray8,wd=5pt}, %column{2} = {co=1}, 
  colsep = 5pt,
%  row{odd} = {gray8},% row{even} = {gray8},
  column{1} = {fg=black, bg=azure8, font=\sffamily},%{\bfseries\sffamily},
  row{1} = {fg=black, bg=azure8, font=\bfseries\sffamily},
  rowhead = 1,
  colspec = {lX[8]X[13]X[-1]X[5]},
}
%%Shared line header
\NewTableCommand\reportline[1]{\SetCell[c=#1]{l}}
%%Research Activities Table Header
\newcommand\tableheader{&Deliverable&{Writing Outcome:\\ by the end of this stage you will}&Effort&Supervisor Interaction\\}
