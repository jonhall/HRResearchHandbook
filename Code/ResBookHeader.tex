%%======================================================================
%% Document language & quotation handling
%%======================================================================
\usepackage[UKenglish]{babel}
\usepackage[threshold=1]{csquotes} % load before biblatex

%%======================================================================
%% Document headers
%%======================================================================
\usepackage{fancyhdr}

%%======================================================================
%% Bibliography (biblatex + biber)
%%======================================================================
\usepackage[
  style=authoryear,
  autocite=inline,
  sortcites,
  backref=true,
  refsegment=part
]{biblatex}
\addbibresource{Bibs/MastersBib.bib}
\addbibresource{collatedBib.bib}

%%======================================================================
%% Fonts & maths (XeLaTeX via mathspec)
%%======================================================================
\usepackage{mathspec} % loads fontspec + amsmath
% --- Workaround for mathspec package loader quirk (as in your original) ---
\makeatletter
\let\RequirePackage\original@RequirePackage
\let\usepackage\RequirePackage
\makeatother

\setmainfont[
  Ligatures=TeX
]{Arial}
\setmathfont(Latin)[Scale=MatchLowercase]{BentonSans Book}

%%======================================================================
%% Layout, graphics, colours, micro-typography
%%======================================================================
\usepackage{geometry}
\geometry{
  left=2cm,
  right=1cm,
  top=1.5cm,
  bottom=1.5cm,
  marginparsep=8mm,
  marginparwidth=55mm,
  includemp,
  includefoot
}

\usepackage{graphicx}
\graphicspath{{Figures/}}

\usepackage[svgnames]{xcolor}
\usepackage{microtype} % safe with XeLaTeX; improves justification/kerning

%% Maths must be seen before cleveref
\usepackage{amsmath} % safe even if mathspec already loaded it

%% Xrefs
\usepackage{xurl}
\usepackage{hyperref}      % after biblatex
\usepackage{bookmark}      % immediately after hyperref
\usepackage[capitalise,noabbrev]{cleveref} % after amsmath + hyperref

%% -------------------------------------------------------------------
%% URLs, hyperlinks, cross-references (no \hypersetup, no nameinlink)
%% Place these as early as possible after \documentclass
%% -------------------------------------------------------------------
\PassOptionsToPackage{hyphens}{url} % allow URL line breaks
\PassOptionsToPackage{unicode,linktoc=all,pdfborder={0 0 0}}{hyperref}

% Make sure amsmath is seen before cleveref to avoid the warning
\makeatletter
\@ifpackageloaded{amsmath}{}{\usepackage{amsmath}}
% Load hyperref only if not already loaded by the class or another package
\@ifpackageloaded{hyperref}{}{\usepackage{hyperref}}
\makeatother

% xurl after hyperref extends URL breaking without changing options
\usepackage{xurl}
% bookmark immediately after hyperref
\usepackage{bookmark}
% cleveref without nameinlink (recommended), but with your other prefs
\usepackage[capitalise,noabbrev]{cleveref}

%%======================================================================
%% Code-ish verbatim for tables
%%======================================================================
\usepackage{codehigh}

%%======================================================================
%% ToC / headings (Stages)
%%======================================================================
\usepackage{titling}
\usepackage{tocloft,calc} % \widthof for number width calculations

\crefname{part}{Stage}{Stages}
\Crefname{part}{Stage}{Stages}

% ToC: show "Stage I"
\renewcommand{\cftpartpresnum}{Stage~}
\renewcommand{\cftpartaftersnum}{\quad}
\setlength{\cftpartnumwidth}{\widthof{Stage~\Roman{part}\quad}}

%Correct babel's tendency to name parts Parts.
\addto\captionsUKenglish{%
  \renewcommand{\partname}{Stage}%
}


%%======================================================================
%% Numbering depth
%%======================================================================
\setcounter{secnumdepth}{2} % subsection
\setcounter{tocdepth}{2}    % up to subsection in ToC

%%======================================================================
%% Glossary (bib2gls workflow)
%%======================================================================
\usepackage[
  record,
  postpunc={dot},
  nostyles,
  stylemods={tree}
]{glossaries-extra}

\GlsXtrLoadResources[
  src={Bibs/glossary.bib},
  selection={all},
  field-aliases={fulllong=long},
  trigger-type=ignored,
  category={same as entry}
]
% Process with: bib2gls <jobname>.aux

%%======================================================================
%% Quotes (styling)
%%======================================================================
\renewcommand{\mktextquote}[6]{#1\emph{#2}#4#3#6#5}
\renewcommand{\mkblockquote}[4]{#1\emph{#2}#4#3}

%%======================================================================
%% Symbols
%%======================================================================
\usepackage{amssymb}

%%======================================================================
%% Project-specific environments & tables
%%======================================================================
\input{environments.tex}
\input{tables.tex}
\input{WOtables.tex}

%%======================================================================
%% TODO notes
%%======================================================================
\usepackage[textsize=tiny,obeyFinal]{todonotes}

%%======================================================================
%% Load last (as requested)
%%======================================================================
\usepackage{listliketab}

%%======================================================================
%% Utility macros
%%======================================================================
\newcommand\etc{etc}