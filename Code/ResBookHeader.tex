%%======================================================================
%% Document language & quotation handling
%%======================================================================
\usepackage[UKenglish]{babel}
\usepackage[threshold=1]{csquotes} % load before biblatex

%%%======================================================================
%%% Document headers
%%%======================================================================
%\usepackage{fancyhdr}

%%======================================================================
%% Bibliography (biblatex + biber)
%%======================================================================
\usepackage[
  style=authoryear,
  autocite=inline,
  sortcites,
  backref=true,
  refsegment=part
]{biblatex}
\addbibresource{Bibs/MastersBib.bib}
\addbibresource{collatedBib.bib}
\DeclareDelimFormat{nameyeardelim}{\addcomma\space}%%Comma separator.

%%Ensure bibliography always included, even if \end{document} early
\AtEndDocument{\printbibliography}

%%======================================================================
%% Fonts & maths (XeLaTeX via mathspec)
%%======================================================================
\usepackage{mathspec} % loads fontspec + amsmath
% --- Workaround for mathspec package loader quirk (as in your original) ---
\makeatletter
\let\RequirePackage\original@RequirePackage
\let\usepackage\RequirePackage
\makeatother

\setmainfont[
  Ligatures=TeX
]{Arial}
\setmathfont(Latin)[Scale=MatchLowercase]{BentonSans Book}

%%======================================================================
%% Layout, graphics, colours, micro-typography
%%======================================================================
\usepackage{geometry}
\geometry{
  left=2cm,
  right=1cm,
  top=1.5cm,
  bottom=1.5cm,
  marginparsep=8mm,
  marginparwidth=55mm,
  includemp,
  includefoot
}

\usepackage{graphicx}
\graphicspath{{Figures/}}

\usepackage[svgnames]{xcolor}
\usepackage{microtype} % safe with XeLaTeX; improves justification/kerning

%% Maths must be seen before cleveref
\usepackage{amsmath} % safe even if mathspec already loaded it

%% Xrefs
\usepackage{xurl}
\usepackage{hyperref}      % after biblatex
\usepackage{bookmark}      % immediately after hyperref
\usepackage[capitalise,noabbrev]{cleveref} % after amsmath + hyperref

%% -------------------------------------------------------------------
%% URLs, hyperlinks, cross-references (no \hypersetup, no nameinlink)
%% Place these as early as possible after \documentclass
%% -------------------------------------------------------------------
\PassOptionsToPackage{hyphens}{url} % allow URL line breaks
\PassOptionsToPackage{unicode,linktoc=all,pdfborder={0 0 0}}{hyperref}

% Make sure amsmath is seen before cleveref to avoid the warning
\makeatletter
\@ifpackageloaded{amsmath}{}{\usepackage{amsmath}}
% Load hyperref only if not already loaded by the class or another package
\@ifpackageloaded{hyperref}{}{\usepackage{hyperref}}
\makeatother

% xurl after hyperref extends URL breaking without changing options
\usepackage{xurl}
% bookmark immediately after hyperref
\usepackage{bookmark}
% cleveref without nameinlink (recommended), but with your other prefs
\usepackage[capitalise,noabbrev]{cleveref}

%%======================================================================
%% Code-ish verbatim for tables
%%======================================================================
\usepackage{codehigh}

%%======================================================================
%% memoir ToC / headings (Stages)
%%======================================================================

%%======================================================================
%% Numbering depth
%%======================================================================

\RequirePackage{calc}%%for \widthof{...}
% How much detail to include
\setsecnumdepth{subsubsection}
\settocdepth{subsubsection}

% Dots between title and page â€“ memoir *does* provide \cftdotsep
\renewcommand*{\cftdotsep}{4}

% --- Parts in ToC ---
\renewcommand{\cftpartpresnum}{Stage~}
\renewcommand{\cftpartaftersnum}{\quad}
\renewcommand*{\cftpartfont}{\bfseries}
\renewcommand*{\cftpartpagefont}{\bfseries}
\setlength{\cftpartindent}{0em}
\setlength{\cftpartnumwidth}{\widthof{Stage~XXX\ }}
\setlength{\cftbeforepartskip}{2.5em}

% --- Chapters in ToC ---
\renewcommand{\cftchapterpresnum}{Chapter~}
\renewcommand{\cftchapteraftersnum}{\quad}
\renewcommand*{\cftchapterfont}{\bfseries}
\renewcommand*{\cftchapterpagefont}{\bfseries}
\setlength{\cftchapterindent}{0em}
\setlength{\cftchapternumwidth}{\widthof{Chapter~99\ }}
\setlength{\cftbeforechapterskip}{1.5em}

% --- Sections in ToC ---
\renewcommand*{\cftsectionfont}{\normalfont}
\renewcommand*{\cftsectionpagefont}{\normalfont}
\setlength{\cftsectionindent}{1.5em}      % <-- section, not sec
\setlength{\cftsectionnumwidth}{\widthof{99.99\ }}      % <-- sectionnumwidth
\setlength{\cftbeforesectionskip}{0.2em}  % <-- beforesectionskip

% --- Subsections in ToC ---
\setlength{\cftsubsectionindent}{\widthof{99.99.99\ }}         % <-- subsection, not subsec
\setlength{\cftsubsectionnumwidth}{3.5em}     % <-- subsectionnumwidth
% (optional)
% \setlength{\cftbeforesubsectionskip}{0.2em}

\crefname{part}{Stage}{Stages}
\Crefname{part}{Stage}{Stages}

%Correct babel's tendency to name parts Parts.
\addto\captionsUKenglish{%
  \renewcommand{\partname}{Stage}%
}


%%======================================================================
%% Glossary (bib2gls workflow)
%%======================================================================
\usepackage[
  record,
  postpunc={dot},
  nostyles,
  stylemods={tree}
]{glossaries-extra}

\GlsXtrLoadResources[
  src={Bibs/glossary.bib},
  selection={all},
  field-aliases={fulllong=long},
  trigger-type=ignored,
  category={same as entry}
]
% Process with: bib2gls <jobname>.aux

%%======================================================================
%% Quotes (styling)
%%======================================================================
\renewcommand{\mktextquote}[6]{#1\emph{#2}#4#3#6#5}
\renewcommand{\mkblockquote}[4]{#1\emph{#2}#4#3}

%%======================================================================
%% Symbols
%%======================================================================
\usepackage{amssymb}

%%======================================================================
%% Project-specific environments & tables
%%======================================================================
\input{environments.tex}
\input{tables.tex}
\input{WOtables.tex}

%%======================================================================
%% TODO notes
%%======================================================================
\usepackage[textsize=tiny,obeyFinal]{todonotes}

%%======================================================================
%% Load last (as requested)
%%======================================================================
\usepackage{listliketab}

%%======================================================================
%% Utility macros
%%======================================================================
\newcommand\etc{etc}