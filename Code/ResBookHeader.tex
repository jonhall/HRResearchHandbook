%=======================================================
% Document language & quotation handling
%=======================================================
\usepackage[UKenglish]{babel}
\usepackage[threshold=1]{csquotes} % load before biblatex

%=======================================================
%% Bibliography (biblatex + biker
%=====================================================
\usepackage[
  style=authoryear,
  autocite=inline,
  sortcites,
  backref=true,
  refsegment=part
]{biblatex}
\addbibresource{Bibs/MastersBib.bib}
\addbibresource{collatedBib.bib}
%Comma separator.
	\DeclareDelimFormat{nameyeardelim}{\addcomma\space}%

%======================================================
% Fonts & maths (XeLaTeX via mathspec)
%======================================================
\usepackage{mathspec} % loads fontspec + amsmath
% --- Workaround for mathspec package loader quirk (as in your original) ---
\makeatletter
\let\RequirePackage\original@RequirePackage
\let\usepackage\RequirePackage
\makeatother

\setmainfont[
  Ligatures=TeX
]{Arial}
\setmathfont(Latin)[Scale=MatchLowercase]{BentonSans Book}

%=======================================================
% Layout, graphics, colours, micro-typography
%=====================================================
\usepackage{geometry}
\geometry{
  left=2cm,
  right=1cm,
  top=1.5cm,
  bottom=1.5cm,
  marginparsep=8mm,
  marginparwidth=55mm,
  includemp,
  includefoot
}

\usepackage{graphicx}
\graphicspath{{Figures/}}

\usepackage[svgnames]{xcolor}
\usepackage{microtype} % safe with XeLaTeX; improves justification/kerning

%% Maths must be seen before cleveref
\usepackage{amsmath} % safe even if mathspec already loaded it

%% Xrefs
\usepackage{xurl}
\usepackage[
%%%% for underlined, only in pdf
%	colorlinks=false,
%	allbordercolors={0 0 0},
%    pdfborderstyle={/S/U/W 1},
%    hyperfootnotes = false,
	colorlinks=true,
	linkcolor=blue,	
    ]{hyperref}      % after biblatex
%%Hyperref manual: All those (footnote) redefinitions can be suppressed by defining \hyper@nopatch@footnote
%\makeatletter
%\let\hyper@nopatch@footnote\relax
%\makeatother

%\usepackage{bookmark}      % immediately after hyperref
%\usepackage[capitalise,noabbrev]{cleveref} % after amsmath + hyperref

% ------------------------------------------------------
% URLs, hyperlinks, cross-references (no \hypersetup, no nameinlink)
% Place these as early as possible after \documentclass
% ------------------------------------------------------
\PassOptionsToPackage{hyphens}{url} % allow URL line breaks
\PassOptionsToPackage{unicode,linktoc=all,pdfborder={0 0 0}}{hyperref}

% Make sure amsmath is seen before cleveref to avoid the warning
\makeatletter
\@ifpackageloaded{amsmath}{}{\usepackage{amsmath}}
% Load hyperref only if not already loaded by the class or another package
\@ifpackageloaded{hyperref}{}{\usepackage{hyperref}}
\makeatother

% xurl after hyperref extends URL breaking without changing options
\usepackage{xurl}
% bookmark immediately after hyperref
\usepackage{bookmark}
% cleveref without nameinlink (recommended), but with your other prefs
\usepackage[capitalise,noabbrev]{cleveref}

%=======================================================
%% Fake verb for tables
%=======================================================
\usepackage{codehigh}

%=======================================================
%% Titlesec to avoid orphans (https://tex.stackexchange.com/questions/2347/avoiding-page-breaks-shortly-after-section-subsection-headings)
%=======================================================
\usepackage[nobottomtitles*]{titlesec}

%======================================================
%% Numbering depth
%%====================================================

\RequirePackage{calc}%%for \widthof{...}
% How much detail to include
\setsecnumdepth{subsubsection}
\settocdepth{subsubsection}

% Dots between title and page â€“ memoir *does* provide \cftdotsep
\renewcommand*{\cftdotsep}{4}

% --- Parts in ToC ---
\renewcommand{\cftpartpresnum}{Stage~}
\renewcommand{\cftpartaftersnum}{\quad}
\renewcommand*{\cftpartfont}{\bfseries}
\renewcommand*{\cftpartpagefont}{\bfseries}
\setlength{\cftpartindent}{0em}
\setlength{\cftpartnumwidth}{\widthof{Stage~XXX\ }}
\setlength{\cftbeforepartskip}{2.5em}

% --- Chapters in ToC ---
\renewcommand{\cftchapterpresnum}{Chapter~}
\renewcommand{\cftchapteraftersnum}{\quad}
\renewcommand*{\cftchapterfont}{\bfseries}
\renewcommand*{\cftchapterpagefont}{\bfseries}
\setlength{\cftchapterindent}{0em}
\setlength{\cftchapternumwidth}{\widthof{Chapter~99\ }}
\setlength{\cftbeforechapterskip}{1.5em}

% --- Sections in ToC ---
\renewcommand*{\cftsectionfont}{\normalfont}
\renewcommand*{\cftsectionpagefont}{\normalfont}
\setlength{\cftsectionindent}{1.5em}      % <-- section, not sec
\setlength{\cftsectionnumwidth}{\widthof{99.99\ }}      % <-- sectionnumwidth
\setlength{\cftbeforesectionskip}{0.2em}  % <-- beforesectionskip

% --- Subsections in ToC ---
\setlength{\cftsubsectionindent}{\widthof{99.99.99\ }}         % <-- subsection, not subsec
\setlength{\cftsubsectionnumwidth}{3.5em}     % <-- subsectionnumwidth
% (optional)
% \setlength{\cftbeforesubsectionskip}{0.2em}

\crefname{part}{Stage}{Stages}
\Crefname{part}{Stage}{Stages}

%Correct babel's tendency to name parts Parts.
\addto\captionsUKenglish{%
  \renewcommand{\partname}{Stage}%
}

%=============================================
%	Glossary
%=============================================
\input{Code/glossary}		% create glossaries
\input{Code/glossary-mods}	% restrict gls to 1st on page

%=======================================================
% Quotes (styling)
%=======================================================
\renewcommand{\mktextquote}[6]{#1\emph{#2}#4#3#6#5}
\renewcommand{\mkblockquote}[4]{#1\emph{#2}#4#3}

%=======================================================
% Symbols
%=======================================================
\usepackage{amssymb}

%=======================================================
% Project-specific environments & tables
%=======================================================
\input{Code/environments.tex}
\input{Code/tables.tex}
\input{Code/WOtables.tex}

%=======================================================
% TO{}DO notes
%=======================================================
\usepackage[textsize=tiny,obeyFinal]{todonotes}

%=======================================================
% Load last (as requested)
%=======================================================
\usepackage{listliketab}

%=======================================================
% Utility macros
%=======================================================
\newcommand\etc{etc}
\newcommand{\glsforce}[2]{\glsadd{#1}\glshyperlink[#2]{#1}}

%=======================================================
% Initial background page
%=======================================================
\usepackage{eso-pic}

% Put a full-page background image on the *current* page
\newcommand{\BackgroundPic}[1]{%
  \AddToShipoutPictureBG*{%
    \AtPageLowerLeft{%
      \includegraphics[width=\paperwidth,height=\paperheight]{#1}%
    }%
  }%
}

%=======================================================
% Massive title text
%=======================================================
\makeatletter
\renewcommand{\maketitle}{%
  \thispagestyle{empty}% no page number on title page
  \begin{center}
    {\HUGE\bfseries \@title\par}
    \vspace{1.2\baselineskip}
    {\Huge \@author\par}
    \vspace{0.8\baselineskip}
    {\large \@date\par}
  \end{center}
  \BackgroundPic{Images/Coverpic}
  \clearpage
}
\makeatother