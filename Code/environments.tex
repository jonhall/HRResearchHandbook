%%%For Activities and the like
%%TODO clean up Activity code
\newcommand{\exampleColor}{CornflowerBlue!40!white}
\newcommand{\activityColor}{Pink!70!white} 
\newcommand{\discussionColor}{\activityColor} 
\newcommand{\tipColor}{Green!20!white} 
\newcommand{\quoteColor}{Linen} 
\newcommand{\takeawaysColor}{black!10!white}
\newcommand{\frameColor}{black!50!white}

%%for activities, etc
\usepackage[many]{tcolorbox}
%%Add marginnote for marginal footnotes
\RequirePackage{marginnote}

% A tcolorbox style that swaps \footnote for a margin note locally
\tcbset{
  footnotes-in-margin/.style={
    before upper={
      \let\realfootnote\footnote
      \renewcommand{\footnote}[1]{%
        \refstepcounter{footnote}%
        \textsuperscript{\thefootnote}%
        \marginnote{\footnotesize\thefootnote\quad ####1}%
      }%
    },
    after upper={\let\footnote\realfootnote},
  },
}

%%Default tcbox settings
\tcbset{%
%  enhanced,
  breakable,
  footnotes-in-margin,
%  before={\par\Needspace{5\baselineskip}}, % adjust to taste
  pad at break=2mm,
  left=2mm,
  right=2mm,
  width=\textwidth, 
  frame hidden, 
  segmentation hidden,
%  before=\par\vspace*{2mm},
  after=\par\bigskip,
  colframe=\frameColor,
}

%%Takeaways
\newtcolorbox{takeaways}[1]{
	move upwards=\topmargin,
	colback=\takeawaysColor,
	title={\Large{#1 Takeaways}},
  }

%%Activities
\newtcolorbox{activity}{
  colback=\activityColor,
  title=%\textbf
		{\GetQuestionProperty{subtitle}{\CurrentQuestionID}\hfill\#\CurrentQuestionID}
}

%%Discussions
\newtcolorbox{discussion}{
  colback=\discussionColor,
  title={Discussion\hfill \#\CurrentQuestionID},
}

%%Guidance environment
\newenvironment{guidance}{\tcbsubtitle%[before skip=\baselineskip]%
          {Guidance}}
    {}

%%tips
\newtcolorbox{tip}{
  colback=\tipColor,
  title={Tip},
}

\newtcolorbox{example}[1]{
  colback=\exampleColor,
  title=\textbf{Example: #1}}%
  
\newtcolorbox{running}[1]{
  colback=\exampleColor,
  title=\textbf{#1}}%

%%Quote environment
\renewtcolorbox{quote}{
  colback=\quoteColor,
  title=\textbf{Quote}}%
  
%%Answer environment
%%Is this used?
\newenvironment{answer}{\textbf{Answer}\begin{trivlist}
\item}
    {\end{trivlist}}
    
%%%For question solution pairs, with optional delayed printing
\usepackage{exsheets}
\SetupExSheets{
	headings=empty,
	question/pre-hook=\begin{activity},
	question/post-hook=\end{activity},
	solution/pre-hook=\IfInsideQuestionTF{\tcbsubtitle{Discussion}}{\begin{discussion}},
	solution/post-hook=\IfInsideQuestionTF{}{\end{discussion}},
	solution/print=true,
	}
%\ifoptionfinal{\SetupExSheets{solution/print=false}}{}	

%%%%%%% for choosing strategies/methods and related further deep dive into literature
%%%%From Stage 4
%%Resource type = fulltext cite in itemized list
%%From authoryear.cbx
%% Candidate for moving to header files
\DeclareMultiCiteCommand{\fullcites}{\fullcite}{\multicitedelim\\}

\DeclareCiteCommand{\resourcelistcite}
  {\usebibmacro{prenote}\begin{itemize}\item[] }
  {\usedriver
     {\DeclareNameAlias{sortname}{default}}
     {\thefield{entrytyper}}
  } 
%     {%
%		\footnote{\thefield{annotation}}
%	 }
  {\item[] \addspace}
  {\end{itemize}\usebibmacro{postnote}}

\newenvironment{MoreDetails}[0]{\subsection{More details} The following citations provide good starting points for further reading: \label{ssect:MoreDetails}}{}


\newcommand{\ResGenTechnique}[1]{\begin{question}[subtitle={Activity: Do I need to know about #1?}]
Check back to your chosen research strategy from Stage 3. Does it involve data generation using #1? If so, read through the remainder of this section and complete the activities.
\end{question}}

\newcommand{\ResGenExtras}[2]{\begin{question}[subtitle={Activity: Deep dive into #1}]
To find out more about #1, take a look at these resources:

\fullcites#2

\end{question}}

\newcommand{\ResModTechnique}[1]{\begin{question}[subtitle={Activity: Do I need to know about #1?}]
Check back to your chosen research strategy from Stage 3. Does it involve modelling using #1? If so, read through the remainder of this section and complete the activities.
\end{question}}

\newcommand{\ResModExtras}[2]{\begin{question}[subtitle={Activity: Deep dive into #1}]
To find out more about #1, take a look at these resources:

\fullcites#2

\end{question}}

\newcommand{\ReadingExtras}[2]{\begin{question}[subtitle={Activity: Deep dive into #1}]
To find out more about #1, take a look at these resources:

\fullcites#2

\end{question}}

%%%%%%%%%